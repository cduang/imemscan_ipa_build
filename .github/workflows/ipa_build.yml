# iMemScan iOSåº”ç”¨æ„å»ºå·¥ä½œæµ

name: ğŸš€ æ„å»ºå¹¶å‘å¸ƒiMemScan IPA (ä¼˜åŒ–ç‰ˆ)

# å®šä¹‰å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # ä»…å…è®¸åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: 'auto'  # æ·»åŠ é»˜è®¤å€¼

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # å…è®¸å†™å…¥å†…å®¹ï¼ˆåˆ›å»ºreleaseï¼‰
  packages: write  # å…è®¸ä¸Šä¼ æ–‡ä»¶

# å®šä¹‰æ„å»ºé…ç½®
env:
  DESTINATION: 'generic/platform=iOS'  # æ„å»ºç›®æ ‡å¹³å°
  CONFIGURATION: 'Release'  # æ„å»ºé…ç½®
  SCHEME: 'iMemScan'  # é¡¹ç›®scheme
  LANGUAGE: 'zh-Hans'  # è®¾ç½®ä¸ºç®€ä½“ä¸­æ–‡
  
jobs:
  build:
    name: ğŸ—ï¸ æ„å»ºiMemScan IPA
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: ğŸ› ï¸ è®¾ç½®Xcodeç¯å¢ƒ
      uses: maxim-lobanov/setup-xcode@v1  # ä¸æŒ‡å®šç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤æœ€æ–°ç‰ˆæœ¬
    
    - name: å®‰è£…ä¾èµ–å·¥å…·
      run: |
        # å®‰è£… ldid å·¥å…·ç”¨äºç­¾å
        brew install ldid
        # ç¡®è®¤ ldid å·²å®‰è£…
        which ldid
    
    # ä¿®æ”¹é¡¹ç›®çš„é»˜è®¤è¯­è¨€è®¾ç½®
    - name: ä¿®æ”¹é¡¹ç›®é»˜è®¤è¯­è¨€
      run: |
        echo "ä¿®æ”¹é¡¹ç›®é»˜è®¤å¼€å‘åŒºåŸŸä¸ºä¸­æ–‡..."
        
        # ä¿®æ”¹é¡¹ç›®çš„developmentRegionä¸ºä¸­æ–‡
        sed -i '' 's/developmentRegion = en;/developmentRegion = "zh-Hans";/g' iMemScan.xcodeproj/project.pbxproj
        
        # ç¡®ä¿ä¸­æ–‡åœ¨knownRegionsåˆ—è¡¨çš„é¦–ä½
        sed -i '' 's/knownRegions = (/knownRegions = (\n\t\t\t\t"zh-Hans",/g' iMemScan.xcodeproj/project.pbxproj
        
        # æ£€æŸ¥ä¿®æ”¹ç»“æœ
        grep -A 5 "developmentRegion" iMemScan.xcodeproj/project.pbxproj
        grep -A 5 "knownRegions" iMemScan.xcodeproj/project.pbxproj
    
    # å¢å¼ºè¯­è¨€è®¾ç½®
    - name: è®¾ç½®è¯­è¨€ç¯å¢ƒå’Œæœ¬åœ°åŒ–
      run: |
        # è®¾ç½®åº”ç”¨æ˜¾ç¤ºåç§°å’Œè¯­è¨€ä»£ç 
        DISPLAY_NAME="å†…å­˜æ‰«æ"
        DEV_LANGUAGE="zh-Hans"
        
        # æŸ¥çœ‹ Info.plist åˆå§‹å†…å®¹
        echo "æ£€æŸ¥ Info.plist åˆå§‹å†…å®¹ï¼š"
        /usr/libexec/PlistBuddy -c "Print" "iMemScan/Info.plist"
        
        # ç¡®ä¿ CFBundleDisplayName è®¾ç½®æ­£ç¡®
        if ! /usr/libexec/PlistBuddy -c "Print :CFBundleDisplayName" "iMemScan/Info.plist" &>/dev/null; then
            /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string $DISPLAY_NAME" "iMemScan/Info.plist"
        else
            /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName $DISPLAY_NAME" "iMemScan/Info.plist"
        fi
        
        # è®¾ç½®å¼€å‘è¯­è¨€ä¸ºä¸­æ–‡
        /usr/libexec/PlistBuddy -c "Set :CFBundleDevelopmentRegion $DEV_LANGUAGE" "iMemScan/Info.plist"
        
        # ç¡®ä¿æœ¬åœ°åŒ–è®¾ç½®
        if ! /usr/libexec/PlistBuddy -c "Print :CFBundleLocalizations" "iMemScan/Info.plist" &>/dev/null; then
            /usr/libexec/PlistBuddy -c "Add :CFBundleLocalizations array" "iMemScan/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleLocalizations:0 string $DEV_LANGUAGE" "iMemScan/Info.plist"
        else
            # æ¸…é™¤ç°æœ‰æœ¬åœ°åŒ–è®¾ç½®å¹¶é‡æ–°æ·»åŠ ä¸­æ–‡
            /usr/libexec/PlistBuddy -c "Delete :CFBundleLocalizations" "iMemScan/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleLocalizations array" "iMemScan/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleLocalizations:0 string $DEV_LANGUAGE" "iMemScan/Info.plist"
        fi
        
        # ç¡®ä¿é¦–é€‰è¯­è¨€ä¸ºä¸­æ–‡
        if ! /usr/libexec/PlistBuddy -c "Print :CFBundlePrimaryLanguage" "iMemScan/Info.plist" &>/dev/null; then
            /usr/libexec/PlistBuddy -c "Add :CFBundlePrimaryLanguage string $DEV_LANGUAGE" "iMemScan/Info.plist"
        else
            /usr/libexec/PlistBuddy -c "Set :CFBundlePrimaryLanguage $DEV_LANGUAGE" "iMemScan/Info.plist"
        fi
        
        # æ·»åŠ AppleLanguagesè®¾ç½®ï¼Œå¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡
        if ! /usr/libexec/PlistBuddy -c "Print :AppleLanguages" "iMemScan/Info.plist" &>/dev/null; then
            /usr/libexec/PlistBuddy -c "Add :AppleLanguages array" "iMemScan/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :AppleLanguages:0 string $DEV_LANGUAGE" "iMemScan/Info.plist"
        else
            /usr/libexec/PlistBuddy -c "Delete :AppleLanguages" "iMemScan/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :AppleLanguages array" "iMemScan/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :AppleLanguages:0 string $DEV_LANGUAGE" "iMemScan/Info.plist"
        fi
        
        # è®¾ç½®é»˜è®¤è¯­è¨€è®¾ç½®
        if ! /usr/libexec/PlistBuddy -c "Print :CFBundlePreferredLocalizations" "iMemScan/Info.plist" &>/dev/null; then
            /usr/libexec/PlistBuddy -c "Add :CFBundlePreferredLocalizations array" "iMemScan/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundlePreferredLocalizations:0 string $DEV_LANGUAGE" "iMemScan/Info.plist"
        else
            /usr/libexec/PlistBuddy -c "Delete :CFBundlePreferredLocalizations" "iMemScan/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundlePreferredLocalizations array" "iMemScan/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundlePreferredLocalizations:0 string $DEV_LANGUAGE" "iMemScan/Info.plist"
        fi
        
        # æ˜¾ç¤ºä¿®æ”¹åçš„ Info.plist å†…å®¹
        echo "ä¿®æ”¹åçš„ Info.plist å†…å®¹ï¼š"
        /usr/libexec/PlistBuddy -c "Print" "iMemScan/Info.plist"
        
        # æ£€æŸ¥å¹¶ç¡®ä¿Localizable.stringsæ–‡ä»¶æ­£ç¡®
        echo "æ£€æŸ¥æœ¬åœ°åŒ–å­—ç¬¦ä¸²æ–‡ä»¶..."
        if [ -f "iMemScan/zh-Hans.lproj/Localizable.strings" ]; then
            echo "ä¸­æ–‡æœ¬åœ°åŒ–å­—ç¬¦ä¸²æ–‡ä»¶å­˜åœ¨"
            cat "iMemScan/zh-Hans.lproj/Localizable.strings"
        else
            echo "è­¦å‘Šï¼šä¸­æ–‡æœ¬åœ°åŒ–å­—ç¬¦ä¸²æ–‡ä»¶ä¸å­˜åœ¨ï¼"
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "APP_DISPLAY_NAME=$DISPLAY_NAME" >> $GITHUB_ENV
        echo "DEVELOPMENT_LANGUAGE=$DEV_LANGUAGE" >> $GITHUB_ENV
    
    # åªåˆ›å»ºä¸€ä¸ªä¿®æ”¹è„šæœ¬ï¼Œé¿å…YAMLè¯­æ³•é—®é¢˜
    - name: åˆ›å»ºä¿®æ”¹ViewControllerçš„è„šæœ¬
      run: |
        # åˆ›å»ºè„šæœ¬æ–‡ä»¶
        echo "#!/bin/bash" > fix_viewcontroller.sh
        echo "# æ·»åŠ å¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡çš„è®¾ç½®" >> fix_viewcontroller.sh
        echo "# ä¿®æ”¹ViewController.swift" >> fix_viewcontroller.sh
        echo "cp iMemScan/ViewController.swift iMemScan/ViewController.swift.bak" >> fix_viewcontroller.sh
        echo "grep -q 'AppleLanguages' iMemScan/ViewController.swift || sed -i '' '/super.viewDidLoad()/ a\\
        \\ \\ \\ \\ \\ \\ \\ \\ // å¼ºåˆ¶è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡\\
        \\ \\ \\ \\ \\ \\ \\ \\ UserDefaults.standard.set\\([\\\"zh-Hans\\\"]\\, forKey: \\\"AppleLanguages\\\"\\)\\
        \\ \\ \\ \\ \\ \\ \\ \\ UserDefaults.standard.synchronize\\(\\)\\
        ' iMemScan/ViewController.swift" >> fix_viewcontroller.sh
        echo "chmod +x fix_viewcontroller.sh" >> fix_viewcontroller.sh
        echo "# è„šæœ¬åˆ›å»ºå®Œæˆ" >> fix_viewcontroller.sh
        
        # èµ‹äºˆæ‰§è¡Œæƒé™
        chmod +x fix_viewcontroller.sh
        
        # æ‰§è¡Œè„šæœ¬
        ./fix_viewcontroller.sh
        
        # æ˜¾ç¤ºä¿®æ”¹åçš„æ–‡ä»¶
        echo "ä¿®æ”¹åçš„ViewController.swiftå†…å®¹ï¼š"
        cat iMemScan/ViewController.swift
    
    - name: ğŸ­ æ„å»ºé¡¹ç›®
      run: |
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build/ipa
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export LANGUAGE=${{ env.LANGUAGE }}
        
        # å¹¶è¡Œæ„å»ºé…ç½®
        CPU_COUNT=$(sysctl -n hw.ncpu)
        echo "ä½¿ç”¨ $CPU_COUNT ä¸ªCPUæ ¸å¿ƒè¿›è¡Œæ„å»º"
        
        # æ„å»ºé¡¹ç›®ï¼ˆä½¿ç”¨å¹¶è¡Œç¼–è¯‘ï¼‰ï¼Œå¢åŠ è¯­è¨€ç›¸å…³å‚æ•°
        xcodebuild -project iMemScan.xcodeproj \
                  -scheme $SCHEME \
                  -configuration $CONFIGURATION \
                  -destination "$DESTINATION" \
                  -archivePath $PWD/build/iMemScan.xcarchive \
                  -parallelizeTargets \
                  -jobs $CPU_COUNT \
                  -quiet \
                  clean archive \
                  CODE_SIGNING_ALLOWED=NO \
                  CODE_SIGNING_REQUIRED=NO \
                  CODE_SIGN_IDENTITY="" \
                  PROVISIONING_PROFILE="" \
                  PROVISIONING_PROFILE_SPECIFIER="" \
                  DEVELOPMENT_TEAM="" \
                  PRODUCT_BUNDLE_IDENTIFIER="com.imemscan.app.$LANGUAGE" \
                  PRODUCT_BUNDLE_DISPLAY_NAME="${{ env.APP_DISPLAY_NAME }}" \
                  INFOPLIST_KEY_CFBundleDisplayName="${{ env.APP_DISPLAY_NAME }}" \
                  DEVELOPMENT_LANGUAGE="${{ env.DEVELOPMENT_LANGUAGE }}" \
                  -UseModernBuildSystem=YES \
                  -clonedSourcePackagesDirPath "$PWD/build/cloned_source_packages"
        
        # æ‰‹åŠ¨åˆ›å»ºPayloadç›®å½•å¹¶å¤åˆ¶.appæ–‡ä»¶
        mkdir -p build/ipa/Payload
        cp -r build/iMemScan.xcarchive/Products/Applications/*.app build/ipa/Payload/
        
        # æ£€æŸ¥å¹¶ä¿®æ”¹åº”ç”¨ä¸­çš„Info.plist
        APP_INFO_PLIST="build/ipa/Payload/iMemScan.app/Info.plist"
        if [ -f "$APP_INFO_PLIST" ]; then
            echo "ä¿®æ”¹åº”ç”¨åŒ…ä¸­çš„Info.plist..."
            /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName å†…å­˜æ‰«æ" "$APP_INFO_PLIST"
            /usr/libexec/PlistBuddy -c "Set :CFBundleDevelopmentRegion zh-Hans" "$APP_INFO_PLIST"
            
            # ç¡®ä¿æœ‰æ­£ç¡®çš„æœ¬åœ°åŒ–è®¾ç½®
            if ! /usr/libexec/PlistBuddy -c "Print :CFBundleLocalizations" "$APP_INFO_PLIST" &>/dev/null; then
                /usr/libexec/PlistBuddy -c "Add :CFBundleLocalizations array" "$APP_INFO_PLIST"
                /usr/libexec/PlistBuddy -c "Add :CFBundleLocalizations:0 string zh-Hans" "$APP_INFO_PLIST"
            else
                # æ¸…é™¤ç°æœ‰æœ¬åœ°åŒ–è®¾ç½®å¹¶é‡æ–°æ·»åŠ ä¸­æ–‡
                /usr/libexec/PlistBuddy -c "Delete :CFBundleLocalizations" "$APP_INFO_PLIST"
                /usr/libexec/PlistBuddy -c "Add :CFBundleLocalizations array" "$APP_INFO_PLIST"
                /usr/libexec/PlistBuddy -c "Add :CFBundleLocalizations:0 string zh-Hans" "$APP_INFO_PLIST"
            fi
            
            # æ·»åŠ é¦–é€‰è¯­è¨€
            if ! /usr/libexec/PlistBuddy -c "Print :CFBundlePrimaryLanguage" "$APP_INFO_PLIST" &>/dev/null; then
                /usr/libexec/PlistBuddy -c "Add :CFBundlePrimaryLanguage string zh-Hans" "$APP_INFO_PLIST"
            else
                /usr/libexec/PlistBuddy -c "Set :CFBundlePrimaryLanguage zh-Hans" "$APP_INFO_PLIST"
            fi
            
            # æ·»åŠ AppleLanguagesè®¾ç½®
            if ! /usr/libexec/PlistBuddy -c "Print :AppleLanguages" "$APP_INFO_PLIST" &>/dev/null; then
                /usr/libexec/PlistBuddy -c "Add :AppleLanguages array" "$APP_INFO_PLIST"
                /usr/libexec/PlistBuddy -c "Add :AppleLanguages:0 string zh-Hans" "$APP_INFO_PLIST"
            else
                /usr/libexec/PlistBuddy -c "Delete :AppleLanguages" "$APP_INFO_PLIST"
                /usr/libexec/PlistBuddy -c "Add :AppleLanguages array" "$APP_INFO_PLIST"
                /usr/libexec/PlistBuddy -c "Add :AppleLanguages:0 string zh-Hans" "$APP_INFO_PLIST"
            fi
            
            # è®¾ç½®é»˜è®¤è¯­è¨€åå¥½
            if ! /usr/libexec/PlistBuddy -c "Print :CFBundlePreferredLocalizations" "$APP_INFO_PLIST" &>/dev/null; then
                /usr/libexec/PlistBuddy -c "Add :CFBundlePreferredLocalizations array" "$APP_INFO_PLIST"
                /usr/libexec/PlistBuddy -c "Add :CFBundlePreferredLocalizations:0 string zh-Hans" "$APP_INFO_PLIST"
            else
                /usr/libexec/PlistBuddy -c "Delete :CFBundlePreferredLocalizations" "$APP_INFO_PLIST"
                /usr/libexec/PlistBuddy -c "Add :CFBundlePreferredLocalizations array" "$APP_INFO_PLIST"
                /usr/libexec/PlistBuddy -c "Add :CFBundlePreferredLocalizations:0 string zh-Hans" "$APP_INFO_PLIST"
            fi
            
            echo "ä¿®æ”¹åçš„åº”ç”¨Info.plistå†…å®¹ï¼š"
            /usr/libexec/PlistBuddy -c "Print" "$APP_INFO_PLIST"
        else
            echo "è­¦å‘Šï¼šæ— æ³•æ‰¾åˆ°åº”ç”¨åŒ…ä¸­çš„Info.plist"
        fi
        
        # å¤åˆ¶æœ¬åœ°åŒ–æ–‡ä»¶åˆ°æœ€ç»ˆçš„åº”ç”¨åŒ…ä¸­
        mkdir -p "build/ipa/Payload/iMemScan.app/zh-Hans.lproj"
        cp -f "iMemScan/zh-Hans.lproj/Localizable.strings" "build/ipa/Payload/iMemScan.app/zh-Hans.lproj/"
        echo "å·²å¤åˆ¶æœ¬åœ°åŒ–æ–‡ä»¶åˆ°åº”ç”¨åŒ…"
        
        # ç¡®ä¿ldidå¯ç”¨å¹¶ç­¾ååº”ç”¨
        which ldid
        ldid -Sentitlements.plist build/ipa/Payload/*.app/iMemScan
        
        # åˆ›å»ºå¸¦æ—¥æœŸå’Œè¯­è¨€åç¼€çš„æ–‡ä»¶å
        BUILD_DATE=$(date +'%Y%m%d')
        BUILD_TIME=$(date +'%H%M%S')
        
        # åˆ›å»ºæœ€ç»ˆç‰ˆæœ¬å·
        FINAL_VERSION="${BUILD_DATE}"
        
        # åˆ›å»ºIPAå’ŒTIPAæ–‡ä»¶
        cd build/ipa
        zip -r "../iMemScanTS.ipa" .
        cd ../..
        
        # å¤åˆ¶ä¸º.tipaæ–‡ä»¶
        cp build/iMemScanTS.ipa build/iMemScanTS.tipa
        
        # è®¾ç½®IPAè·¯å¾„ç¯å¢ƒå˜é‡
        IPA_FILENAME="iMemScanTS.tipa"
        echo "IPA_PATH=build/${IPA_FILENAME}" >> $GITHUB_ENV
        echo "IPA_FILENAME=${IPA_FILENAME}" >> $GITHUB_ENV
        echo "FINAL_VERSION=${FINAL_VERSION}" >> $GITHUB_ENV
        echo "BUILD_DATE=${BUILD_DATE}" >> $GITHUB_ENV
        echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_ENV
        
        echo "LANGUAGE=${{ env.LANGUAGE }}" >> $GITHUB_ENV
    
    - name: â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: tipa-builds
        path: build/iMemScanTS.tipa
        retention-days: 3  # ç¼©çŸ­ä¿ç•™æ—¶é—´ï¼Œå‡å°‘å­˜å‚¨ä½¿ç”¨
        compression-level: 9  # æœ€é«˜å‹ç¼©ç‡
    
    - name: è®¾ç½®è¾“å‡ºå˜é‡
      id: set_outputs
      run: |
        echo "final_version=$FINAL_VERSION" >> $GITHUB_OUTPUT
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
    
    - name: ğŸš€ åˆ›å»ºReleaseå¹¶ä¸Šä¼ TIPA
      id: create_release
      # æ·»åŠ è¶…æ—¶è®¾ç½®
      timeout-minutes: 30
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || format('v{0}', steps.set_outputs.outputs.build_date) }}
        name: iMemScan ${{ steps.set_outputs.outputs.build_date }} ç®€ä½“ä¸­æ–‡ç‰ˆ
        files: build/iMemScanTS.tipa
        body: |
          # iMemScan ${{ steps.set_outputs.outputs.build_date }} ç®€ä½“ä¸­æ–‡ç‰ˆ
          
          ### æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ steps.set_outputs.outputs.build_date }} ${{ steps.set_outputs.outputs.build_time }}
          - ç‰ˆæœ¬: ${{ steps.set_outputs.outputs.build_date }}
          - è‡ªåŠ¨æ„å»ºçš„TrollStoreå®‰è£…åŒ…
          
          ### ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½iMemScanTS.tipaæ–‡ä»¶
          2. ä½¿ç”¨TrollStoreå®‰è£…
          3. ç¡®ä¿è®¾å¤‡è¯­è¨€è®¾ç½®ä¸ºç®€ä½“ä¸­æ–‡ä»¥è·å¾—æœ€ä½³ä½“éªŒ
        draft: false
        prerelease: false
        generate_release_notes: true
