# iMemScan iOSåº”ç”¨æ„å»ºå·¥ä½œæµ

name: ğŸš€ æ„å»ºå¹¶å‘å¸ƒiMemScan IPA (ä¼˜åŒ–ç‰ˆ)

# å®šä¹‰å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # ä»…å…è®¸åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: 'auto'  # æ·»åŠ é»˜è®¤å€¼

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # å…è®¸å†™å…¥å†…å®¹ï¼ˆåˆ›å»ºreleaseï¼‰
  packages: write  # å…è®¸ä¸Šä¼ æ–‡ä»¶

# å®šä¹‰æ„å»ºé…ç½®
env:
  DESTINATION: 'generic/platform=iOS'  # æ„å»ºç›®æ ‡å¹³å°
  CONFIGURATION: 'Release'  # æ„å»ºé…ç½®
  SCHEME: 'iMemScan'  # é¡¹ç›®scheme
  LANGUAGE: 'zh-Hans'  # è®¾ç½®ä¸ºç®€ä½“ä¸­æ–‡
  
jobs:
  build:
    name: ğŸ—ï¸ æ„å»ºiMemScan IPA
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: ğŸ› ï¸ è®¾ç½®Xcodeç¯å¢ƒ
      uses: maxim-lobanov/setup-xcode@v1  # ä¸æŒ‡å®šç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤æœ€æ–°ç‰ˆæœ¬
    
    # é¡¹ç›®ä¸ä½¿ç”¨CocoaPodsï¼Œè·³è¿‡ç›¸å…³æ­¥éª¤
    - name: è®¾ç½®è¯­è¨€ç¯å¢ƒ
      run: |
        # è®¾ç½®åº”ç”¨æ˜¾ç¤ºåç§°å’Œè¯­è¨€ä»£ç 
        DISPLAY_NAME="å†…å­˜æ‰«æ"
        DEV_LANGUAGE="zh-Hans"
        
        # æ£€æŸ¥CFBundleDisplayNameæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ 
        if ! /usr/libexec/PlistBuddy -c "Print :CFBundleDisplayName" "iMemScan/Info.plist" &>/dev/null; then
            /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string $DISPLAY_NAME" "iMemScan/Info.plist"
        else
            /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName $DISPLAY_NAME" "iMemScan/Info.plist"
        fi
        
        # è®¾ç½®å¼€å‘è¯­è¨€
        /usr/libexec/PlistBuddy -c "Set :CFBundleDevelopmentRegion $DEV_LANGUAGE" "iMemScan/Info.plist"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "APP_DISPLAY_NAME=$DISPLAY_NAME" >> $GITHUB_ENV
        echo "DEVELOPMENT_LANGUAGE=$DEV_LANGUAGE" >> $GITHUB_ENV
    
    - name: ğŸ­ æ„å»ºé¡¹ç›®
      run: |
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build/ipa
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export LANGUAGE=${{ env.LANGUAGE }}
        
        # å¹¶è¡Œæ„å»ºé…ç½®
        CPU_COUNT=$(sysctl -n hw.ncpu)
        echo "ä½¿ç”¨ $CPU_COUNT ä¸ªCPUæ ¸å¿ƒè¿›è¡Œæ„å»º"
        
        # æ„å»ºé¡¹ç›®ï¼ˆä½¿ç”¨å¹¶è¡Œç¼–è¯‘ï¼‰
        xcodebuild -project iMemScan.xcodeproj \
                  -scheme $SCHEME \
                  -configuration $CONFIGURATION \
                  -destination "$DESTINATION" \
                  -archivePath $PWD/build/iMemScan.xcarchive \
                  -parallelizeTargets \
                  -jobs $CPU_COUNT \
                  -quiet \
                  clean archive \
                  CODE_SIGNING_ALLOWED=NO \
                  CODE_SIGNING_REQUIRED=NO \
                  CODE_SIGN_IDENTITY="" \
                  PROVISIONING_PROFILE="" \
                  PROVISIONING_PROFILE_SPECIFIER="" \
                  DEVELOPMENT_TEAM="" \
                  PRODUCT_BUNDLE_IDENTIFIER="com.imemscan.app.$LANGUAGE" \
                  PRODUCT_BUNDLE_DISPLAY_NAME="${{ env.APP_DISPLAY_NAME }}" \
                  INFOPLIST_KEY_CFBundleDisplayName="${{ env.APP_DISPLAY_NAME }}" \
                  -UseModernBuildSystem=YES \
                  -clonedSourcePackagesDirPath "$PWD/build/cloned_source_packages"
        
        # æ‰‹åŠ¨åˆ›å»ºPayloadç›®å½•å¹¶å¤åˆ¶.appæ–‡ä»¶
        mkdir -p build/ipa/Payload
        cp -r build/iMemScan.xcarchive/Products/Applications/*.app build/ipa/Payload/
        
        # ç­¾ååº”ç”¨
        ldid -Sentitlements.plist build/ipa/Payload/*.app/iMemScan
        
        # åˆ›å»ºå¸¦æ—¥æœŸå’Œè¯­è¨€åç¼€çš„æ–‡ä»¶å
        BUILD_DATE=$(date +'%Y%m%d')
        BUILD_TIME=$(date +'%H%M%S')
        
        # åˆ›å»ºæœ€ç»ˆç‰ˆæœ¬å·
        FINAL_VERSION="${BUILD_DATE}"
        
        # åˆ›å»ºIPAå’ŒTIPAæ–‡ä»¶
        cd build/ipa
        zip -r "../iMemScanTS.ipa" .
        cd ../..
        
        # å¤åˆ¶ä¸º.tipaæ–‡ä»¶
        cp build/iMemScanTS.ipa build/iMemScanTS.tipa
        
        # è®¾ç½®IPAè·¯å¾„ç¯å¢ƒå˜é‡
        IPA_FILENAME="iMemScanTS.tipa"
        echo "IPA_PATH=build/${IPA_FILENAME}" >> $GITHUB_ENV
        echo "IPA_FILENAME=${IPA_FILENAME}" >> $GITHUB_ENV
        echo "FINAL_VERSION=${FINAL_VERSION}" >> $GITHUB_ENV
        echo "BUILD_DATE=${BUILD_DATE}" >> $GITHUB_ENV
        echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_ENV
        
        echo "LANGUAGE=${{ env.LANGUAGE }}" >> $GITHUB_ENV
    
    - name: â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: tipa-builds
        path: build/iMemScanTS.tipa
        retention-days: 3  # ç¼©çŸ­ä¿ç•™æ—¶é—´ï¼Œå‡å°‘å­˜å‚¨ä½¿ç”¨
        compression-level: 9  # æœ€é«˜å‹ç¼©ç‡
    
    - name: è®¾ç½®è¾“å‡ºå˜é‡
      id: set_outputs
      run: |
        echo "final_version=$FINAL_VERSION" >> $GITHUB_OUTPUT
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
    
    - name: ğŸš€ åˆ›å»ºReleaseå¹¶ä¸Šä¼ TIPA
      id: create_release
      # æ·»åŠ è¶…æ—¶è®¾ç½®
      timeout-minutes: 30
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || format('v{0}', steps.set_outputs.outputs.build_date) }}
        name: iMemScan ${{ steps.set_outputs.outputs.build_date }} ç®€ä½“ä¸­æ–‡ç‰ˆ
        files: build/iMemScanTS.tipa
        body: |
          # iMemScan ${{ steps.set_outputs.outputs.build_date }} ç®€ä½“ä¸­æ–‡ç‰ˆ
          
          ### æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ steps.set_outputs.outputs.build_date }} ${{ steps.set_outputs.outputs.build_time }}
          - ç‰ˆæœ¬: ${{ steps.set_outputs.outputs.build_date }}
          - è‡ªåŠ¨æ„å»ºçš„TrollStoreå®‰è£…åŒ…
          
          ### ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½iMemScanTS.tipaæ–‡ä»¶
          2. ä½¿ç”¨TrollStoreå®‰è£…
          3. ç¡®ä¿è®¾å¤‡è¯­è¨€è®¾ç½®ä¸ºç®€ä½“ä¸­æ–‡ä»¥è·å¾—æœ€ä½³ä½“éªŒ
        draft: false
        prerelease: false
        generate_release_notes: true
