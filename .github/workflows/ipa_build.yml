# iMemScan iOSåº”ç”¨å¤šè¯­è¨€æ„å»ºå·¥ä½œæµ

name: ğŸš€ æ„å»ºå¹¶å‘å¸ƒå¤šè¯­è¨€iMemScan IPA (ä¼˜åŒ–ç‰ˆ)

# å®šä¹‰å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # å½“æ¨é€åˆ°mainåˆ†æ”¯æˆ–åˆ›å»ºtagæ—¶è§¦å‘
  push:
    branches: [ main ]
    tags:
      - 'v*'  # åŒ¹é…ä»¥vå¼€å¤´çš„tagï¼Œä¾‹å¦‚v1.0.0
  # å…è®¸åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
  # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 18 * * *'  # UTCæ—¶é—´18ç‚¹ï¼Œå³åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # å…è®¸å†™å…¥å†…å®¹ï¼ˆåˆ›å»ºreleaseï¼‰
  packages: write  # å…è®¸ä¸Šä¼ æ–‡ä»¶

# å®šä¹‰æ„å»ºçŸ©é˜µï¼Œæ”¯æŒä¸‰ç§è¯­è¨€
env:
  DESTINATION: 'generic/platform=iOS'  # æ„å»ºç›®æ ‡å¹³å°
  CONFIGURATION: 'Release'  # æ„å»ºé…ç½®
  SCHEME: 'iMemScan'  # é¡¹ç›®scheme
  
jobs:
  build:
    name: ğŸ—ï¸ æ„å»ºå¤šè¯­è¨€IPA [${{ matrix.language }}]
    runs-on: macos-latest
    strategy:
      matrix:
        language: ['zh-Hans', 'en', 'de']
      fail-fast: false  # ä¸€ä¸ªè¯­è¨€æ„å»ºå¤±è´¥ä¸å½±å“å…¶ä»–è¯­è¨€
      max-parallel: 3    # æœ€å¤§å¹¶è¡Œä»»åŠ¡æ•°
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: ğŸ› ï¸ è®¾ç½®Xcodeç¯å¢ƒ
      uses: maxim-lobanov/setup-xcode@v1  # ä¸æŒ‡å®šç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤æœ€æ–°ç‰ˆæœ¬
    
    # é¡¹ç›®ä¸ä½¿ç”¨CocoaPodsï¼Œè·³è¿‡ç›¸å…³æ­¥éª¤
    - name: è®¾ç½®è¯­è¨€ç¯å¢ƒ
      run: |
        # æ ¹æ®è¯­è¨€è®¾ç½®åº”ç”¨æ˜¾ç¤ºåç§°ã€bundleåç§°å’Œè¯­è¨€ä»£ç 
        case "${{ matrix.language }}" in
          "zh-Hans")
            DISPLAY_NAME="å†…å­˜æ‰«æ"
            SUFFIX="_CN"
            DEV_LANGUAGE="zh-Hans"
            ;;
          "de")
            DISPLAY_NAME="Speicher-Scan"
            SUFFIX="_DE"
            DEV_LANGUAGE="de"
            ;;
          *)
            DISPLAY_NAME="iMemScan"
            SUFFIX="_EN"
            DEV_LANGUAGE="en"
            ;;
        esac
        
        # æ£€æŸ¥CFBundleDisplayNameæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ 
        if ! /usr/libexec/PlistBuddy -c "Print :CFBundleDisplayName" "iMemScan/Info.plist" &>/dev/null; then
            /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string $DISPLAY_NAME" "iMemScan/Info.plist"
        else
            /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName $DISPLAY_NAME" "iMemScan/Info.plist"
        fi
        
        # è®¾ç½®å¼€å‘è¯­è¨€
        /usr/libexec/PlistBuddy -c "Set :CFBundleDevelopmentRegion $DEV_LANGUAGE" "iMemScan/Info.plist"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "APP_DISPLAY_NAME=$DISPLAY_NAME" >> $GITHUB_ENV
        echo "LANGUAGE_SUFFIX=$SUFFIX" >> $GITHUB_ENV
        echo "DEVELOPMENT_LANGUAGE=$DEV_LANGUAGE" >> $GITHUB_ENV
    
    - name: ğŸ­ æ„å»ºé¡¹ç›®
      run: |
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build/ipa
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export LANGUAGE=${{ matrix.language }}
        
        # å¹¶è¡Œæ„å»ºé…ç½®
        CPU_COUNT=$(sysctl -n hw.ncpu)
        echo "ä½¿ç”¨ $CPU_COUNT ä¸ªCPUæ ¸å¿ƒè¿›è¡Œæ„å»º"
        
        # æ„å»ºé¡¹ç›®ï¼ˆä½¿ç”¨å¹¶è¡Œç¼–è¯‘ï¼‰
        xcodebuild -project iMemScan.xcodeproj \
                  -scheme $SCHEME \
                  -configuration $CONFIGURATION \
                  -destination "$DESTINATION" \
                  -archivePath $PWD/build/iMemScan.xcarchive \
                  -parallelizeTargets \
                  -jobs $CPU_COUNT \
                  -quiet \
                  clean archive \
                  CODE_SIGNING_ALLOWED=NO \
                  CODE_SIGNING_REQUIRED=NO \
                  CODE_SIGN_IDENTITY="" \
                  PROVISIONING_PROFILE="" \
                  PROVISIONING_PROFILE_SPECIFIER="" \
                  DEVELOPMENT_TEAM="" \
                  PRODUCT_BUNDLE_IDENTIFIER="com.imemscan.app.$LANGUAGE" \
                  PRODUCT_BUNDLE_DISPLAY_NAME="${{ env.APP_DISPLAY_NAME }}" \
                  INFOPLIST_KEY_CFBundleDisplayName="${{ env.APP_DISPLAY_NAME }}" \
                  -UseModernBuildSystem=YES \
                  -clonedSourcePackagesDirPath "$PWD/build/cloned_source_packages"
        
        # æ‰‹åŠ¨åˆ›å»ºPayloadç›®å½•å¹¶å¤åˆ¶.appæ–‡ä»¶
        mkdir -p build/ipa/Payload
        cp -r build/iMemScan.xcarchive/Products/Applications/*.app build/ipa/Payload/
        
        # åˆ›å»ºå¸¦æ—¶é—´æˆ³å’Œè¯­è¨€åç¼€çš„æ–‡ä»¶å
        TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
        VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "iMemScan/Info.plist")
        BUILD_NUMBER=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "iMemScan/Info.plist")
        
        # åˆ›å»ºIPAæ–‡ä»¶
        cd build/ipa
        zip -r "../iMemScan_v${VERSION_NUMBER}_${BUILD_NUMBER}_${TIMESTAMP}${{ env.LANGUAGE_SUFFIX }}.ipa" .
        cd ../..
        
        # è®¾ç½®IPAè·¯å¾„ç¯å¢ƒå˜é‡
        IPA_FILENAME="iMemScan_v${VERSION_NUMBER}_${BUILD_NUMBER}_${TIMESTAMP}${{ env.LANGUAGE_SUFFIX }}.ipa"
        echo "IPA_PATH=build/${IPA_FILENAME}" >> $GITHUB_ENV
        echo "IPA_FILENAME=${IPA_FILENAME}" >> $GITHUB_ENV
        
        # è·å–ç‰ˆæœ¬å·
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION_NUMBER="${{ github.event.inputs.version }}"
        else
          VERSION_NUMBER="${VERSION}"
        fi
        # è®¾ç½®ç‰ˆæœ¬å·ç¯å¢ƒå˜é‡
        echo "VERSION_NUMBER=${VERSION_NUMBER}" >> $GITHUB_ENV
        echo "BUILD_NUMBER=${BUILD_NUMBER}" >> $GITHUB_ENV
        # ç¡®ä¿ç‰ˆæœ¬å·æ ¼å¼æ­£ç¡®
        FINAL_VERSION="${VERSION_NUMBER}_${BUILD_NUMBER}"
        echo "VERSION=${FINAL_VERSION}" >> $GITHUB_ENV
        echo "FINAL_VERSION=${FINAL_VERSION}" >> $GITHUB_ENV
        
        echo "LANGUAGE=${{ matrix.language }}" >> $GITHUB_ENV
    
    - name: â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ipa-builds-${{ matrix.language }}
        path: ${{ env.IPA_PATH }}
        retention-days: 3  # ç¼©çŸ­ä¿ç•™æ—¶é—´ï¼Œå‡å°‘å­˜å‚¨ä½¿ç”¨
        compression-level: 9  # æœ€é«˜å‹ç¼©ç‡
    
    - name: ğŸš€ åˆ›å»ºReleaseå¹¶ä¸Šä¼ IPA
      if: matrix.language == 'zh-Hans'  # åªç”±ä¸­æ–‡æ„å»ºä»»åŠ¡åˆ›å»ºrelease
      id: create_release
      # æ·»åŠ è¶…æ—¶è®¾ç½®
      timeout-minutes: 30
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || format('v{0}', github.event.inputs.version) }}
        name: iMemScan ${{ env.FINAL_VERSION }} å¤šè¯­è¨€ç‰ˆæœ¬
        files: ${{ env.IPA_PATH }}
        file_glob: true
        body: |
          # iMemScan ${{ env.FINAL_VERSION }} å¤šè¯­è¨€ç‰ˆæœ¬
          
          ### æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ env.TIMESTAMP }}
          - ç‰ˆæœ¬: ${{ env.FINAL_VERSION }}
          - åŒ…å«è¯­è¨€: ç®€ä½“ä¸­æ–‡, English, Deutsch
          - è‡ªåŠ¨æ„å»ºçš„æœªç­¾åIPAæ–‡ä»¶
          
          ### æ–‡ä»¶è¯´æ˜
          - `*_CN.ipa`: ç®€ä½“ä¸­æ–‡ç‰ˆ
          - `*_EN.ipa`: è‹±æ–‡ç‰ˆ
          - `*_DE.ipa`: å¾·æ–‡ç‰ˆ
          
          ### ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¯¹åº”è¯­è¨€ç‰ˆæœ¬çš„IPAæ–‡ä»¶
          2. ä½¿ç”¨ç­¾åå·¥å…·ç­¾ååå®‰è£…åˆ°è¶Šç‹±è®¾å¤‡
          3. ç¡®ä¿è®¾å¤‡è¯­è¨€è®¾ç½®ä¸å®‰è£…çš„ç‰ˆæœ¬åŒ¹é…ä»¥è·å¾—æœ€ä½³ä½“éªŒ
        draft: false
        prerelease: false
        generate_release_notes: true
    
    - name: â¬†ï¸ ä¸Šä¼ å…¶ä»–è¯­è¨€ç‰ˆæœ¬åˆ°Release
      if: matrix.language != 'zh-Hans'  # ä¸­æ–‡ç‰ˆæœ¬å·²åœ¨åˆ›å»ºreleaseæ—¶ä¸Šä¼ 
      uses: softprops/action-gh-release@v1
      # æ·»åŠ è¶…æ—¶è®¾ç½®
      timeout-minutes: 15
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || format('v{0}', github.event.inputs.version) }}
        files: ${{ env.IPA_PATH }}
        draft: false
        prerelease: false